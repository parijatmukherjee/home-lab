FROM jetbrains/teamcity-agent:latest

# Install build dependencies
USER root

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3-pip \
    python3-dev \
    build-essential \
    live-build \
    debootstrap \
    xorriso \
    squashfs-tools \
    syslinux-utils \
    shellcheck \
    yamllint && \
    rm -rf /var/lib/apt/lists/*

# Upgrade pip and install teamcity-messages globally
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install teamcity-messages pytest bats

# Create docker-compose wrapper for backward compatibility
# The agent has Docker Compose v2 (docker compose) but many projects use docker-compose
RUN echo '#!/bin/sh\nexec docker compose "$@"' > /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose

# Switch back to buildagent user
USER buildagent

# Verify installation
RUN python3 -m pip --version && \
    python3 -c "import teamcity.messages; print('teamcity-messages installed successfully')" && \
    docker-compose version && \
    lb --version && \
    debootstrap --version && \
    xorriso -version | head -1 && \
    mksquashfs -version | head -1
