FROM jetbrains/teamcity-agent:latest

# Install pip and other common Python tools
USER root

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    python3-pip \
    python3-dev \
    build-essential && \
    rm -rf /var/lib/apt/lists/*

# Upgrade pip and install teamcity-messages globally
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install teamcity-messages

# Create docker-compose wrapper for backward compatibility
# The agent has Docker Compose v2 (docker compose) but many projects use docker-compose
RUN echo '#!/bin/sh\nexec docker compose "$@"' > /usr/local/bin/docker-compose && \
    chmod +x /usr/local/bin/docker-compose

# Switch back to buildagent user
USER buildagent

# Verify installation
RUN python3 -m pip --version && \
    python3 -c "import teamcity.messages; print('teamcity-messages installed successfully')" && \
    docker-compose version
